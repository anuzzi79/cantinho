<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin Blog - O Cantinho</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="Icons-App/cantinho.png" sizes="any">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  
  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    .admin-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }

    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .btn-new-post {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      width: 100%;
      max-width: 600px;
      border-radius: var(--radius-lg);
      padding: 30px;
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Post Management List */
    .posts-admin-list {
      display: grid;
      gap: 15px;
    }

    .post-admin-card {
      background: white;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: grab;
    }

    .post-admin-card:active { cursor: grabbing; }

    .post-admin-info { flex: 1; }
    .post-admin-info h3 { font-size: 1rem; margin-bottom: 4px; }
    .post-admin-info span { font-size: 0.8rem; color: var(--text-muted); }

    .post-admin-actions {
      display: flex;
      gap: 10px;
    }

    .btn-action {
      border: none;
      background: #f0f0f0;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-action:hover { background: #e0e0e0; }
    .btn-delete:hover { background: #fee2e2; color: #dc2626; }

    .view-badge {
      background: #fdf2f2;
      color: #d93025;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
      border: 1px solid #fee2e2;
    }

    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      font-family: inherit;
    }

    /* Flag Switch Styles */
    .lang-switcher {
      display: flex;
      gap: 10px;
      background: white;
      padding: 5px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      margin-right: 15px;
    }

    .lang-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      opacity: 0.4;
      transition: opacity 0.2s, transform 0.2s;
      padding: 0;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lang-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .lang-btn:hover { opacity: 0.7; }
    .lang-btn.active {
      opacity: 1;
      transform: scale(1.1);
      box-shadow: 0 0 0 2px var(--primary);
    }

    /* Mappa */
    .stats-container {
      background: white;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    }
    .stats-header {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #regions_div {
      width: 100%; 
      height: 300px;
      border-radius: 8px;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <main class="page">
    <div class="admin-container">
      <nav style="margin-bottom: 20px;">
        <a href="settings.html" style="text-decoration: none; color: var(--text-muted);">‚Üê Torna a Settings</a>
      </nav>

      <div class="stats-container">
        <div class="stats-header">
           üåç Provenienza Visitatori
        </div>
        <div id="regions_div">
           <p style="color: #999; padding: 20px; text-align: center;">Caricamento mappa...</p>
        </div>
      </div>

      <div class="admin-header">
        <div style="display: flex; align-items: center; gap: 20px;">
          <h1>Gestione Diario</h1>
          <div class="lang-switcher">
            <button class="lang-btn active" id="lang-it" title="Italiano">
              <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzIDIiPjxwYXRoIGZpbGw9IiMwMDkyNDYiIGQ9Ik0wIDBoMXYySDB6Ii8+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEgMGgxdjJIMUMxeiIvPjxwYXRoIGZpbGw9IiNjZTJiMzciIGQ9Ik0yIDBoMXYySDJ6Ii8+PC9zdmc+" alt="IT">
            </button>
            <button class="lang-btn" id="lang-pt" title="Portugu√™s">
              <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA3MjAgNTA0Ij48cGF0aCBmaWxsPSIjMDA5YzNiIiBkPSJNMCAwaDcyMHY1MDRIMHoiLz48cGF0aCBmaWxsPSIjZmNjeDAwIiBkPSJNMzYwIDQyTDM4IDI1MmwzMjIgMjEwIDMyMi0yMTB6Ii8+PHBhdGggZmlsbD0iIzAwMjE3MyIgZD0iTTQ5MCAyNTJhMTMwIDEzMCAwIDEgMS0yNjAgMCAxMzAgMTMwIDAgMSAxIDI2MCAweiIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik0zMzIgMjAwczYwLTE3IDg5IDU1bC0yMiA4cy0zMy0zNi02Ny02M3oiLz48L3N2Zz4=" alt="BR">
            </button>
          </div>
        </div>
        <button class="btn-new-post" id="open-modal-btn">
          <span>+</span> Nuovo Post
        </button>
      </div>

      <div id="admin-posts-list" class="posts-admin-list">
        <!-- Post carichi qui -->
        <p>Caricamento post...</p>
      </div>
    </div>

    <!-- Modal per Nuovo/Modifica Post -->
    <div id="post-modal" class="modal">
      <div class="modal-content">
        <h2 id="modal-title">Nuovo Post</h2>
        <div style="margin-bottom: 20px; font-size: 0.9rem; color: var(--text-muted);">
          Lingua selezionata: <span id="modal-lang-label" style="font-weight: bold;">üáÆüáπ Italiano</span>
        </div>
        <form id="post-form">
          <input type="hidden" id="edit-post-id">
          <div class="form-group">
            <label>Titolo</label>
            <input type="text" id="post-title" required>
          </div>
          <div class="form-group">
            <label>Immagine del Post (Condivisa)</label>
            <div style="display: flex; gap: 15px; align-items: center;">
              <button class="btn-new-post" type="button" style="background: #f0f0f0; color: #333; margin: 0; position: relative; overflow: hidden;">
                <span>üìÅ Sfoglia...</span>
                <input type="file" id="post-image-file" accept="image/*" style="position: absolute; inset: 0; opacity: 0; cursor: pointer;">
              </button>
              <img id="post-image-preview" src="" style="width: 80px; height: 45px; object-fit: cover; border-radius: 4px; display: none; border: 1px solid var(--border-soft);">
              <input type="hidden" id="post-image-data">
            </div>
          </div>
          <div class="form-group">
            <label>Contenuto</label>
            <textarea id="post-content" rows="8" required></textarea>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="save-btn" style="flex: 1; margin: 0;">Salva Post</button>
            <button type="button" id="close-modal-btn" class="btn-action" style="flex: 1;">Annulla</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, doc, addDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDdFk-2f8EBqepoRXC10yoASiBQ3gpMt4k",
      authDomain: "cantinho-b2b09.firebaseapp.com",
      projectId: "cantinho-b2b09",
      storageBucket: "cantinho-b2b09.firebasestorage.app",
      messagingSenderId: "1035287669836",
      appId: "1:1035287669836:web:a64eed7bae8a5aa31998e9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const postsList = document.getElementById('admin-posts-list');
    const modal = document.getElementById('post-modal');
    const postForm = document.getElementById('post-form');
    const imageInput = document.getElementById('post-image-file');
    const imagePreview = document.getElementById('post-image-preview');
    const imageDataInput = document.getElementById('post-image-data');
    
    // Gestione Lingua
    let currentLang = 'it'; // 'it' o 'pt'
    const btnIt = document.getElementById('lang-it');
    const btnPt = document.getElementById('lang-pt');
    const modalLangLabel = document.getElementById('modal-lang-label');

    btnIt.onclick = () => switchLang('it');
    btnPt.onclick = () => switchLang('pt');

    function switchLang(lang) {
      currentLang = lang;
      
      // Update UI Buttons
      if (lang === 'it') {
        btnIt.classList.add('active');
        btnPt.classList.remove('active');
        modalLangLabel.textContent = 'üáÆüáπ Italiano';
        document.body.style.backgroundColor = ''; // Reset
      } else {
        btnPt.classList.add('active');
        btnIt.classList.remove('active');
        modalLangLabel.textContent = 'üáßüá∑ Portugu√™s';
        document.body.style.backgroundColor = '#eafaf1'; // Verdino chiarissimo
      }

      loadAdminPosts();
    }

    // Gestione selezione immagine (Base64) con Compressione
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        imagePreview.style.display = 'block';
        imagePreview.src = "https://www.google.com/images/spin-32.gif";

        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            const max = 1200;

            if (width > max) {
              height *= max / width;
              width = max;
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
            
            imageDataInput.value = compressedBase64;
            imagePreview.src = compressedBase64;
            imagePreview.style.display = 'block';
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // MAPPA GOOGLE CHARTS
    google.charts.load('current', {
      'packages':['geochart']
    });
    
    google.charts.setOnLoadCallback(drawRegionsMap);

    async function drawRegionsMap() {
      // 1. Recupera dati da Firebase
      try {
         const statsRef = doc(db, "stats", "locations");
         const statsSnap = await getDoc(statsRef);
         
         let chartData = [['Country', 'Visite']];
         
         if (statsSnap.exists()) {
           const data = statsSnap.data();
           // Converte oggetto { "IT": 10, "BR": 5 } in array
           Object.keys(data).forEach(countryCode => {
             chartData.push([countryCode, data[countryCode]]);
           });
         } else {
           // Dati di default per non mostrare mappa vuota
           chartData.push(['IT', 1]);
         }

         // 2. Disegna Mappa
         const dataTable = google.visualization.arrayToDataTable(chartData);

         const options = {
           colorAxis: {colors: ['#e0f7fa', '#006064']}, // Gradiente verdino/blu
           backgroundColor: '#fff',
           datalessRegionColor: '#f5f5f5',
           defaultColor: '#f5f5f5',
         };

         const chart = new google.visualization.GeoChart(document.getElementById('regions_div'));
         chart.draw(dataTable, options);
      } catch (err) {
        console.error("Errore caricamento mappa:", err);
        document.getElementById('regions_div').innerHTML = '<p>Dati mappa non disponibili.</p>';
      }
    }

    // Ridisegna mappa al resize
    window.addEventListener('resize', drawRegionsMap);


    async function loadAdminPosts() {
      const q = query(collection(db, "posts"), orderBy("date", "desc"));
      const snapshot = await getDocs(q);
      postsList.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        const post = docSnap.data();
        const id = docSnap.id;
        const date = new Date(post.date).toLocaleDateString();
        
        // Logica titolo in base alla lingua
        let displayTitle = '';
        let isMissing = false;

        if (currentLang === 'it') {
          // Retrocompatibilit√†: usa post.title se esiste, altrimenti post.title_it
          displayTitle = post.title_it || post.title;
          if (!displayTitle) {
             displayTitle = "(Titolo in italiano mancante)";
             isMissing = true;
          }
        } else {
          // Versione PT
          displayTitle = post.title_pt;
          if (!displayTitle) {
             displayTitle = "(Titolo in PT brasil)";
             isMissing = true;
          }
        }

        const titleStyle = isMissing ? 'color: #999; font-style: italic;' : '';

        const card = document.createElement('div');
        card.className = 'post-admin-card';
        card.innerHTML = `
          <div class="post-admin-info">
            <h3 style="${titleStyle}">${displayTitle}</h3>
            <span>üìÖ ${date}</span>
            <span class="view-badge">
              üëÅÔ∏è ${post.views || 0} visite
            </span>
          </div>
          <div class="post-admin-actions">
            <button class="btn-action" onclick="window.editPost('${id}')">‚úèÔ∏è</button>
            <button class="btn-action btn-delete" onclick="window.deletePost('${id}')">üóëÔ∏è</button>
          </div>
        `;
        postsList.appendChild(card);
      });
    }

    window.editPost = async (id) => {
      const docRef = doc(db, "posts", id);
      const postSnap = await getDoc(docRef);
      
      if (postSnap.exists()) {
        const post = postSnap.data();
        document.getElementById('edit-post-id').value = id;
        
        // Carica campi in base alla lingua corrente
        if (currentLang === 'it') {
           document.getElementById('post-title').value = post.title_it || post.title || '';
           document.getElementById('post-content').value = post.content_it || post.content || '';
        } else {
           document.getElementById('post-title').value = post.title_pt || '';
           document.getElementById('post-content').value = post.content_pt || '';
        }

        // Immagine √® condivisa
        imageDataInput.value = post.imageUrl || '';
        if (post.imageUrl) {
          imagePreview.src = post.imageUrl;
          imagePreview.style.display = 'block';
        } else {
          imagePreview.style.display = 'none';
        }

        document.getElementById('modal-title').textContent = isPostNew(post) ? 'Nuovo Post' : 'Modifica Post';
        modal.style.display = 'flex';
      }
    };

    function isPostNew(post) {
       if (currentLang === 'it') return !(post.title_it || post.title);
       return !post.title_pt;
    }

    window.deletePost = async (id) => {
      if (confirm('Sei sicuro di voler cancellare questo post? Verranno eliminate TUTTE le versioni (IT e PT).')) {
        try {
          await deleteDoc(doc(db, "posts", id));
          alert("Post eliminato con successo!");
          await loadAdminPosts();
        } catch (error) {
          console.error("Errore nella cancellazione:", error);
          alert("Errore durante la cancellazione del post: " + error.message);
        }
      }
    };

    postForm.onsubmit = async (e) => {
      e.preventDefault();
      
      const submitBtn = postForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "Salvataggio in corso...";

      const id = document.getElementById('edit-post-id').value;
      const titleVal = document.getElementById('post-title').value;
      const contentVal = document.getElementById('post-content').value;
      const imageUrl = imageDataInput.value || "Icons-App/cantinho.png";

      // Costruiamo l'oggetto aggiornamento dinamico
      const updateData = {};
      
      // Immagine e data sempre aggiornate/preservate
      updateData.imageUrl = imageUrl;
      
      if (currentLang === 'it') {
         updateData.title_it = titleVal;
         updateData.content_it = contentVal;
         // Aggiorniamo anche i campi legacy per sicurezza/fallback
         updateData.title = titleVal;
         updateData.content = contentVal;
      } else {
         updateData.title_pt = titleVal;
         updateData.content_pt = contentVal;
      }

      try {
        if (id) {
          await updateDoc(doc(db, "posts", id), updateData);
        } else {
          // Nuovo post: crea con data e views
          await addDoc(collection(db, "posts"), { 
            ...updateData, 
            date: new Date().toISOString(),
            views: 0 
          });
        }
        
        alert("Post salvato con successo!");
        modal.style.display = 'none';
        postForm.reset();
        imagePreview.style.display = 'none';
        loadAdminPosts();
      } catch (error) {
        console.error("Errore nel salvataggio del post:", error);
        alert("Errore nel salvataggio del post: " + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    };

    document.getElementById('open-modal-btn').onclick = () => {
      document.getElementById('edit-post-id').value = '';
      postForm.reset();
      imageDataInput.value = '';
      imagePreview.style.display = 'none';
      document.getElementById('modal-title').textContent = 'Nuovo Post';
      modal.style.display = 'flex';
    };

    document.getElementById('close-modal-btn').onclick = () => modal.style.display = 'none';
    
    loadAdminPosts();
  </script>
</body>
</html>
